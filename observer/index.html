<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Unpossible Observer</title>
  <style>
    /* Unpossible color palette - a totally original yellow theme */
    :root {
      --unpossible-yellow: #FED90F;
      --unpossible-blue: #70D1FE;
      --unpossible-orange: #F14E28;
      --unpossible-brown: #5C4033;
      --unpossible-pink: #FF6B9D;
      --unpossible-sky: #87CEEB;
      --bg-dark: #1a1a2e;
      --bg-darker: #0f0f1a;
      --bg-panel: #252541;
      --text-primary: #FED90F;
      --text-secondary: #87CEEB;
      --border-color: #3d3d5c;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Comic Sans MS', 'Chalkboard', -apple-system, sans-serif;
      background: var(--bg-darker);
      color: var(--text-secondary);
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    header {
      background: var(--bg-dark);
      padding: 16px 24px;
      border-bottom: 3px solid var(--unpossible-yellow);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    h1 {
      font-size: 24px;
      color: var(--unpossible-yellow);
      text-shadow: 2px 2px 0 var(--unpossible-orange);
      letter-spacing: 1px;
    }
    .status {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .status-dot {
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background: #484f58;
      border: 2px solid var(--unpossible-yellow);
    }
    .status-dot.running { background: var(--unpossible-orange); animation: pulse 1s infinite; }
    .status-dot.complete { background: #3fb950; }
    .status-dot.error { background: #f85149; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    .progress-bar {
      width: 200px;
      height: 10px;
      background: var(--bg-panel);
      border-radius: 5px;
      overflow: hidden;
      border: 2px solid var(--unpossible-yellow);
    }
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--unpossible-yellow), var(--unpossible-orange));
      transition: width 0.3s;
    }
    main {
      flex: 1;
      display: flex;
      overflow: hidden;
    }
    .terminal {
      flex: 1;
      background: var(--bg-darker);
      padding: 16px;
      overflow-y: auto;
      font-family: 'SF Mono', Monaco, 'Courier New', monospace;
      font-size: 13px;
      line-height: 1.5;
    }
    .terminal pre {
      white-space: pre-wrap;
      word-break: break-word;
    }
    .stdout { color: var(--text-secondary); }
    .stderr { color: var(--unpossible-orange); }
    .highlight { color: var(--unpossible-yellow); }
    .success { color: #3fb950; }
    .warning { color: var(--unpossible-orange); }
    .sidebar {
      width: 320px;
      background: var(--bg-dark);
      border-left: 3px solid var(--unpossible-yellow);
      padding: 16px;
      overflow-y: auto;
    }
    .sidebar h2 {
      font-size: 14px;
      color: var(--unpossible-yellow);
      margin-bottom: 12px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    .story {
      background: var(--bg-panel);
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 8px;
      border-left: 4px solid #484f58;
    }
    .story.complete { border-left-color: #3fb950; background: rgba(63, 185, 80, 0.1); }
    .story.in-progress { border-left-color: var(--unpossible-orange); }
    .story-id { font-size: 12px; color: var(--unpossible-blue); }
    .story-title { font-size: 14px; margin-top: 4px; color: var(--text-secondary); }
    .current-action {
      background: var(--bg-panel);
      border: 2px solid var(--unpossible-yellow);
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 16px;
    }
    .current-action h3 {
      font-size: 11px;
      color: var(--unpossible-yellow);
      text-transform: uppercase;
      margin-bottom: 8px;
    }
    .action-tool {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .action-tool-name {
      background: rgba(254, 217, 15, 0.2);
      color: var(--unpossible-yellow);
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 600;
    }
    .action-tool-input {
      font-size: 11px;
      color: var(--text-secondary);
      margin-top: 8px;
      max-height: 60px;
      overflow: hidden;
      font-family: monospace;
    }
    .tool-event {
      background: var(--bg-dark);
      border-left: 4px solid var(--unpossible-blue);
      padding: 12px 16px;
      margin: 8px 0;
      font-size: 13px;
      border-radius: 0 8px 8px 0;
    }
    .tool-event.result {
      border-left-color: #3fb950;
      background: rgba(63, 185, 80, 0.1);
    }
    .tool-event.error {
      border-left-color: var(--unpossible-orange);
      background: rgba(241, 78, 40, 0.1);
    }
    .tool-event .tool-name {
      color: var(--unpossible-yellow);
      font-weight: 700;
      font-size: 14px;
      display: inline-block;
      background: rgba(254, 217, 15, 0.2);
      padding: 2px 8px;
      border-radius: 4px;
      margin-right: 8px;
    }
    .tool-event .tool-input {
      color: var(--text-secondary);
      display: block;
      margin-top: 6px;
      font-family: 'SF Mono', Monaco, monospace;
      white-space: pre-wrap;
      word-break: break-all;
    }
    .tool-event .tool-preview {
      color: var(--unpossible-blue);
      font-size: 12px;
      margin-top: 4px;
      max-height: 100px;
      overflow: hidden;
    }
    .thinking-event {
      background: rgba(254, 217, 15, 0.05);
      border-left: 4px solid var(--unpossible-pink);
      padding: 10px 16px;
      margin: 6px 0;
      font-size: 13px;
      color: var(--unpossible-pink);
      font-style: italic;
      border-radius: 0 8px 8px 0;
    }
  </style>
</head>
<body>
  <header>
    <h1>Unpossible Observer</h1>
    <div class="status">
      <span id="status-text">Idle</span>
      <div class="status-dot" id="status-dot"></div>
      <div class="progress-bar">
        <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
      </div>
      <span id="iteration-text">0/0</span>
    </div>
  </header>
  <main>
    <div class="terminal" id="terminal"></div>
    <div class="sidebar">
      <div class="current-action" id="current-action" style="display: none;">
        <h3>Claude is...</h3>
        <div id="action-content"></div>
      </div>
      <h2>Current Branch</h2>
      <p id="branch-name" style="margin-bottom: 16px; color: #58a6ff;">-</p>
      <h2>User Stories</h2>
      <div id="stories"></div>
    </div>
  </main>

  <script>
    const terminal = document.getElementById('terminal');
    const statusText = document.getElementById('status-text');
    const statusDot = document.getElementById('status-dot');
    const progressFill = document.getElementById('progress-fill');
    const iterationText = document.getElementById('iteration-text');
    const branchName = document.getElementById('branch-name');
    const storiesDiv = document.getElementById('stories');
    const currentActionDiv = document.getElementById('current-action');
    const actionContent = document.getElementById('action-content');

    const toolDescriptions = {
      'Read': 'Reading file',
      'Write': 'Writing file',
      'Edit': 'Editing file',
      'Bash': 'Running command',
      'Glob': 'Searching files',
      'Grep': 'Searching content',
      'Task': 'Running agent',
      'TodoWrite': 'Updating tasks'
    };

    function formatOutput(text) {
      return text
        .replace(/Unpossible Iteration \d+ of \d+/g, '<span class="highlight">$&</span>')
        .replace(/PASS/g, '<span class="success">PASS</span>')
        .replace(/FAIL/g, '<span class="warning">FAIL</span>')
        .replace(/Error:/g, '<span class="stderr">Error:</span>')
        .replace(/feat:/g, '<span class="success">feat:</span>');
    }

    function appendOutput(type, text) {
      // Try to parse JSON events from stream-json output
      const lines = text.split('\n');
      for (const line of lines) {
        if (line.trim().startsWith('{')) {
          try {
            const event = JSON.parse(line);
            appendToolEvent(event);
            continue;
          } catch (e) {}
        }
        // Regular text output
        if (line.trim()) {
          const pre = document.createElement('pre');
          pre.className = type;
          pre.innerHTML = formatOutput(line);
          terminal.appendChild(pre);
        }
      }
      terminal.scrollTop = terminal.scrollHeight;
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function appendToolEvent(event) {
      const div = document.createElement('div');

      // Tool use start
      if (event.type === 'content_block_start' && event.content_block?.type === 'tool_use') {
        div.className = 'tool-event';
        const toolName = event.content_block.name;
        const desc = toolDescriptions[toolName] || '';
        div.innerHTML = `<span class="tool-name">${toolName}</span> ${desc}`;
        terminal.appendChild(div);
      }
      // Tool result
      else if (event.type === 'result' && event.subtype === 'tool_result') {
        div.className = 'tool-event result';
        let preview = typeof event.result === 'string'
          ? event.result.substring(0, 300)
          : JSON.stringify(event.result || '').substring(0, 300);
        div.innerHTML = `<span class="tool-name" style="background: #23863626; color: #3fb950;">Done</span>
          <div class="tool-preview">${escapeHtml(preview)}</div>`;
        terminal.appendChild(div);
      }
      // Tool invocation with input
      else if (event.type === 'result' && event.subtype === 'tool_use') {
        div.className = 'tool-event';
        const toolName = event.tool || 'Tool';
        const desc = toolDescriptions[toolName] || '';
        let inputStr = '';
        if (event.input) {
          if (event.input.file_path) inputStr = event.input.file_path;
          else if (event.input.command) inputStr = event.input.command;
          else if (event.input.pattern) inputStr = event.input.pattern;
          else inputStr = JSON.stringify(event.input).substring(0, 200);
        }
        div.innerHTML = `<span class="tool-name">${toolName}</span> ${desc}
          ${inputStr ? `<div class="tool-input">${escapeHtml(inputStr)}</div>` : ''}`;
        terminal.appendChild(div);
      }
      // Text output from Claude
      else if (event.type === 'content_block_delta' && event.delta?.text) {
        div.className = 'thinking-event';
        div.textContent = event.delta.text;
        terminal.appendChild(div);
      }
      // Fallback: show any event with a tool or useful info
      else if (event.tool || event.content_block?.name) {
        div.className = 'tool-event';
        const toolName = event.tool || event.content_block?.name || 'Event';
        const desc = toolDescriptions[toolName] || '';
        let details = '';
        if (event.input?.file_path) details = event.input.file_path;
        else if (event.input?.command) details = event.input.command;
        else if (event.input) details = JSON.stringify(event.input).substring(0, 150);
        div.innerHTML = `<span class="tool-name">${toolName}</span> ${desc}
          ${details ? `<div class="tool-input">${escapeHtml(details)}</div>` : ''}`;
        terminal.appendChild(div);
      }

      if (div.innerHTML) {
        terminal.scrollTop = terminal.scrollHeight;
      }
    }

    function updateAction(action) {
      currentActionDiv.style.display = 'block';
      if (action.type === 'tool' || action.type === 'tool_start') {
        const desc = toolDescriptions[action.tool] || action.tool;
        let inputPreview = '';
        if (action.input) {
          if (action.input.file_path) inputPreview = action.input.file_path;
          else if (action.input.command) inputPreview = action.input.command.substring(0, 50);
          else if (action.input.pattern) inputPreview = action.input.pattern;
        }
        actionContent.innerHTML = `
          <div class="action-tool">
            <span class="action-tool-name">${action.tool}</span>
            <span>${desc}</span>
          </div>
          ${inputPreview ? `<div class="action-tool-input">${inputPreview}</div>` : ''}
        `;
      } else if (action.type === 'thinking') {
        actionContent.innerHTML = `<div style="color: #8b949e; font-style: italic;">${action.text || 'Thinking...'}</div>`;
      } else if (action.type === 'tool_result') {
        actionContent.innerHTML = `<div style="color: #3fb950;">✓ Tool completed</div>`;
      }
    }

    function updateState(state) {
      statusText.textContent = state.status.charAt(0).toUpperCase() + state.status.slice(1);
      statusDot.className = 'status-dot ' + state.status;

      if (state.maxIterations > 0) {
        const pct = (state.iteration / state.maxIterations) * 100;
        progressFill.style.width = pct + '%';
        iterationText.textContent = `${state.iteration}/${state.maxIterations}`;
      }

      if (state.branch) {
        branchName.textContent = state.branch;
      }
    }

    async function loadPRDs() {
      try {
        const res = await fetch('/api/prds');
        const prds = await res.json();
        storiesDiv.innerHTML = '';
        prds.forEach(prd => {
          if (prd.userStories) {
            prd.userStories.forEach(story => {
              const div = document.createElement('div');
              div.className = 'story' + (story.passes ? ' complete' : '');
              div.innerHTML = `
                <div class="story-id">${story.id}</div>
                <div class="story-title">${story.title}</div>
              `;
              storiesDiv.appendChild(div);
            });
          }
        });
      } catch (e) {}
    }

    const evtSource = new EventSource('/events');

    evtSource.addEventListener('state', (e) => {
      updateState(JSON.parse(e.data));
    });

    evtSource.addEventListener('output', (e) => {
      const { type, text } = JSON.parse(e.data);
      appendOutput(type, text);
    });

    evtSource.addEventListener('action', (e) => {
      const action = JSON.parse(e.data);
      updateAction(action);
      // Also show in main terminal
      appendActionToTerminal(action);
    });

    evtSource.addEventListener('claude_event', (e) => {
      const event = JSON.parse(e.data);
      appendToolEvent(event);
    });

    function formatToolInput(toolName, input) {
      if (!input) return '';

      // Special formatting for specific tools
      if (toolName === 'TodoWrite' && input.todos) {
        return input.todos.map(t =>
          `  ${t.status === 'completed' ? '✓' : t.status === 'in_progress' ? '→' : '○'} ${t.content}`
        ).join('\n');
      }
      if (toolName === 'Edit' && input.file_path) {
        let str = input.file_path;
        if (input.old_string) str += `\n  - "${input.old_string.substring(0, 50)}..."`;
        if (input.new_string) str += `\n  + "${input.new_string.substring(0, 50)}..."`;
        return str;
      }
      if (input.file_path) return input.file_path;
      if (input.command) return input.command;
      if (input.pattern) return `pattern: ${input.pattern}`;
      if (input.query) return `query: ${input.query}`;
      if (input.prompt) return input.prompt.substring(0, 150);

      // For other JSON, pretty print with limited depth
      try {
        const simplified = {};
        for (const [k, v] of Object.entries(input)) {
          if (typeof v === 'string') simplified[k] = v.length > 80 ? v.substring(0, 80) + '...' : v;
          else if (Array.isArray(v)) simplified[k] = `[${v.length} items]`;
          else if (typeof v === 'object' && v) simplified[k] = '{...}';
          else simplified[k] = v;
        }
        return JSON.stringify(simplified, null, 2);
      } catch (e) {
        return JSON.stringify(input).substring(0, 200);
      }
    }

    function appendActionToTerminal(action) {
      const div = document.createElement('div');

      if (action.type === 'tool' || action.type === 'tool_start') {
        div.className = 'tool-event';
        const toolName = action.tool || 'Tool';
        const desc = toolDescriptions[toolName] || '';
        const inputStr = formatToolInput(toolName, action.input);
        div.innerHTML = `<span class="tool-name">${toolName}</span> ${desc}
          ${inputStr ? `<div class="tool-input">${escapeHtml(inputStr)}</div>` : ''}`;
        terminal.appendChild(div);
        terminal.scrollTop = terminal.scrollHeight;
      }
      else if (action.type === 'tool_result') {
        div.className = 'tool-event result';
        let preview = '';
        if (action.result) {
          preview = typeof action.result === 'string'
            ? action.result.substring(0, 200)
            : JSON.stringify(action.result, null, 2).substring(0, 200);
        }
        div.innerHTML = `<span class="tool-name" style="background: #23863626; color: #3fb950;">Done</span>
          ${preview ? `<div class="tool-preview">${escapeHtml(preview)}</div>` : ''}`;
        terminal.appendChild(div);
        terminal.scrollTop = terminal.scrollHeight;
      }
      else if (action.type === 'thinking' && action.text) {
        div.className = 'thinking-event';
        div.textContent = action.text;
        terminal.appendChild(div);
        terminal.scrollTop = terminal.scrollHeight;
      }
    }

    evtSource.addEventListener('exit', (e) => {
      const { code } = JSON.parse(e.data);
      appendOutput('stdout', `\n[Process exited with code ${code}]\n`);
    });

    // Load PRDs initially and refresh periodically during runs
    loadPRDs();
    setInterval(loadPRDs, 5000);  // Refresh every 5 seconds to catch story updates
  </script>
</body>
</html>
